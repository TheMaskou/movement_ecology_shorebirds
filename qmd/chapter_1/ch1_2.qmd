---
title: "Explore"
format: html
---

```{r 1 packages, message = FALSE, warning = FALSE, eval = TRUE, echo = FALSE}
 
library(motus) 
library(dplyr)  
library(here)
library(DBI)
library(RSQLite)
library(forcats) 
library(lubridate) 
library(bioRad) 
library(purrr) 
library(ggplot2)
library(tidyr)
library(gt)
library(gtExtras)


# Birds
data_all <- readRDS(
  tail(sort(list.files(
    here::here("qmd", "chapter_1", "data", "motus"),
    pattern = "-data\\.rds$", full.names = TRUE
  )), 1)) 

# Receivers info
recv <- readRDS(
  tail(sort(list.files(
    here::here("qmd", "chapter_1", "data", "motus"),
    pattern = "-recv-info\\.rds$", full.names = TRUE
  )), 1)) 

# Spreadsheet
spreadsheet <- readRDS(
  tail(sort(list.files(
    here::here("qmd", "chapter_1", "data", "spreadsheet"),
    pattern = "-spreadsheet\\.rds$", full.names = TRUE
  )), 1)) 

```

```{r 1 data ktables, message = FALSE, warning = FALSE, eval = TRUE, echo = FALSE}

# Band.IDs in spreadsheet but not in data_all (tagged + released but not detected)
nb_undetect <- spreadsheet %>% 
  filter(is.na(Euthanised.)) %>%
  distinct(Band.ID) %>%
  filter(!Band.ID %in% unique(data_all$Band.ID)) 

# Band.IDs in spreadsheet and in data_all (tagged + released and detected)
nb_detect <- spreadsheet %>% 
  filter(is.na(Euthanised.)) %>%
  distinct(Band.ID) %>%
  filter(Band.ID %in% unique(data_all$Band.ID))

# Bird released (total tagged and released birds, supposed to be detectable) 
nb_release <- spreadsheet %>% 
  filter(is.na(Euthanised.),
         is.na(Retagged.))

# Combine all into Monitoring table table
moni <- bind_rows(
  # Nb of birds trapped & tagged
  tibble(variable = "nb_tagged",
         value  = length(spreadsheet$Band.ID)),
  # Nb of birds euthanised (tag re-used)
  tibble(variable = "nb_euthanised",
         value  = sum(spreadsheet$Euthanised. == "Y", na.rm = TRUE)),
  # Nb of birds re-trapped & re-tagged (initial tag lost)
  tibble(variable = "nb_retagged",
         value  = sum(!is.na(spreadsheet$Retagged.))),
  # Nb of birds trapped, tagged & released (supposed to be detectable)
  tibble(variable = "nb_released",
         value  = nrow(nb_release)),
  # Nb of birds released but never detected
  tibble(variable = "detect_0",
         value  = nrow(nb_undetect)),
  # Nb of birds released with low detection (less than 30 times)
  tibble(variable = "detect_inf_150",
         value  = data_all %>%
           count(Band.ID) %>%
           filter(n < 150) %>% #1*: we can change this treshold value depending our appreciation
           nrow() ),
  # Nb of birds released with good detection (more than 30 times)
  tibble(variable = "detect_sup_150",
         value  = data_all %>%
           count(Band.ID) %>%
           filter(n > 149) %>% #1*
           nrow() ) 
  )

# Undetected, Euthanised & Detected tables
undetect <-  spreadsheet %>% 
  filter(Band.ID %in% nb_undetect$Band.ID)
eutha <-  spreadsheet %>% 
  filter(Euthanised.== "Y")
detect <- spreadsheet %>% 
  filter(Band.ID %in% nb_detect$Band.ID)
retag <- spreadsheet %>% 
  filter(!is.na(spreadsheet$Retagged.))

```

::: {.callout style="border-left: 6px solid #D99B8F; --bs-callout-border: #D99B8F; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;"}
Since 2021, **`r moni$value[moni$variable == "nb_released"]` birds** belonging to **`r length(unique(data_all$speciesEN))` species** have been captured, tagged and released.

**You can find the complete record of the captures [here](https://uonstaff.sharepoint.com/:x:/r/sites/StudentGroupPhD-LouiseWilliamsandMatteaTaylor/_layouts/15/Doc2.aspx?action=edit&sourcedoc=%7Ba23e66f0-c551-4ba4-acd0-de0d5e83ca42%7D&wdOrigin=TEAMS-MAGLEV.teamsSdk_ns.rwc&wdExp=TEAMS-TREATMENT&wdhostclicktime=1765667294608&web=1).**

Motus allows you to openly [explore the data](https://motus.org/dashboard/#e=profile&d=projects&s=294&f=%7B%7D) on the server.

However, it might be useful and more talkative to observe fine and direct movement events from the detections, and to breakdown the data into different groups depending particular point of views and wishes.

Below are displayed several tables to explore the data with every tagged bird uniquely identified with a \`Band.ID*\`*, also related to a *MOTUS tag ID*.
:::

## Motus table

**Find below our data summarised across species and up to date** (last detection `r max(data_all$dateAus)`)**.**

```{r 1 table 1 pop , message = FALSE, warning = FALSE, eval = TRUE, echo = FALSE}

# Nb of individual equipped
n_tagged <- spreadsheet %>% 
  group_by(speciesEN) %>% # per species
  summarise(n_tagged = n())

# Nb of individual never detected
n_undetect <- data_all %>%
  distinct(speciesEN) %>% # to force including all values of species                        
  left_join(spreadsheet %>%
              filter(is.na(Euthanised.),
                     !Band.ID %in% unique(data_all$Band.ID)) %>%
              group_by(speciesEN) %>%
              summarise(n_undetect = n(), .groups = "drop"),
            by = "speciesEN") %>%
  mutate(n_undetect = ifelse(is.na(n_undetect), 0, n_undetect))

# Nb of individual never detected
n_detect <- data_all %>%
  filter(Band.ID %in% (spreadsheet %>% 
                       filter(is.na(Euthanised.)) %>% 
                       pull(Band.ID))) %>%
  distinct(speciesEN, Band.ID) %>%
  count(speciesEN, name = "n_detect")


# Nb of individual re-tagged
n_retagged <- data_all %>%
  distinct(speciesEN) %>% # to force including all values of species                        
  left_join(spreadsheet %>%
              filter(is.na(Euthanised.),
                     !is.na(Retagged.)) %>%
              select(Band.ID, speciesEN, DateAUS.Trap, Location) %>%
              group_by(speciesEN) %>% # per species
              summarise(n_retagged = n()),
            by = "speciesEN") %>%
  mutate(n_retagged = ifelse(is.na(n_retagged), 0, n_retagged))

# First day monitored (trapping/tagging) 
first_d <- spreadsheet %>% 
  group_by(speciesEN) %>% # per species
  mutate(first_d = min(DateAUS.Trap)) %>%
  select(speciesEN, first_d) %>%
  unique() %>%
  mutate(first_d = format(as.Date(first_d), format = "%d-%m-%Y"))

# Last day recorded (detection)
last_d <- data_all %>% 
  group_by(speciesEN) %>% # per species
  mutate(last_d = max(dateAus)) %>%
  select(speciesEN, last_d) %>%
  unique()%>%
  mutate(last_d = format(last_d, format = "%d-%m-%Y"))

# Nb of days monitored, total period of detection (mean + SE)
monit_d <- data_all %>%
  
  group_by(Band.ID) %>% # per individual
  summarise(DateAUS.Trap = first(DateAUS.Trap),         
            last_dateAus = max(dateAus),
            monit_d = as.numeric(last_dateAus - DateAUS.Trap) + 1) %>% 
  
  left_join(data_all %>% select(Band.ID, speciesEN) %>% distinct(), by = "Band.ID") %>%
  
  group_by(speciesEN) %>% # per species
  summarise(n_indiv = n(),
            mean_monit_d = round(mean(monit_d), 1),
            se = sd(monit_d)/sqrt(n_indiv),
            se_lower = mean_monit_d - 1.96*se,
            se_upper = mean_monit_d + 1.96*se,
            mean_monit_d_se = ifelse(is.na(se), 
                                     paste0(" \u00B1 0") , 
                                     paste0(" \u00B1 ", round(se, 1)))) %>%
  ungroup() %>%
  select(speciesEN, mean_monit_d, mean_monit_d_se)

# Nb of days actually detected (mean + SE)
detect_d <- data_all %>%
  
  group_by(Band.ID) %>% # per individual
  summarise(detect_d = n_distinct(dateAus)) %>%
  ungroup()  %>% 
  left_join(data_all %>% select(Band.ID, speciesEN) %>% distinct(), by = "Band.ID") %>%
  
  group_by(speciesEN) %>% # per species
  summarise(n_indiv = n(),
            mean_detect_d = round(mean(detect_d), 1),
            se = sd(detect_d)/sqrt(n_indiv),
            se_lower = mean_detect_d - 1.96*se,
            se_upper = mean_detect_d + 1.96*se,
            mean_detect_d_se = ifelse(is.na(se), 
                                      paste0(" \u00B1 0") , 
                                      paste0(" \u00B1 ", round(se, 1)))) %>%
  ungroup() %>%
  select(speciesEN, mean_detect_d, mean_detect_d_se)

# Nb of sites visited per day (mean + SE)
sites_d <- data_all %>%

  group_by(Band.ID, dateAus) %>% # per individual and day
  summarise(nb_sites = n_distinct(recvDeployName), .groups = "drop") %>%  
  group_by(Band.ID) %>%  
  summarise(nb_sites_d = round(mean(nb_sites), 1)) %>%
  ungroup()  %>% 
  left_join(data_all %>% select(Band.ID, speciesEN) %>% distinct(), by = "Band.ID") %>%
  
  group_by(speciesEN) %>% # per species
  summarise(n_indiv = n(),
            mean_sites_d = round(mean(nb_sites_d), 1),
            se = sd(nb_sites_d)/sqrt(n_indiv),
            se_lower = mean_sites_d - 1.96*se,
            se_upper = mean_sites_d + 1.96*se,
            sites_d_se = ifelse(is.na(se), 
                                paste0(" \u00B1 0") , 
                                paste0(" \u00B1 ", round(se, 1)))) %>%
  ungroup() %>%
  select(speciesEN, mean_sites_d, sites_d_se)

# Nb of sites visited in total (mean + SE)
sites_tot <- data_all %>%
  
  group_by(Band.ID) %>% # per individual
  summarise(sites_tot = n_distinct(recvDeployName), .groups = "drop") %>%  
  ungroup()  %>% 
  left_join(data_all %>% select(Band.ID, speciesEN) %>% distinct(), by = "Band.ID") %>%
  
  group_by(speciesEN) %>% # per species
  summarise(n_indiv = n(),
            mean_sites_tot = round(mean(sites_tot), 1),
            se = sd(sites_tot)/sqrt(n_indiv),
            se_lower = mean_sites_tot - 1.96*se,
            se_upper = mean_sites_tot + 1.96*se,
            sites_tot_se = ifelse(is.na(se), 
                                  paste0(" \u00B1 0") , 
                                  paste0(" \u00B1 ", round(se, 1)))) %>%
  ungroup() %>%
  select(speciesEN, mean_sites_tot, sites_tot_se)

# Gather variables

table_1 <- list(n_tagged,     # nb of individual tagged
                n_detect,     # nb of individual detected
                # n_undetect,   # nb of individual undetected
                n_retagged,   # nb of individual re-tagged
                first_d,       # first day of the first individual tagged
                last_d,        # last day of the last individual detected
                monit_d,       # nb of days between first_d and last_d for each individual
                detect_d,      # nb of days each individual have been detected at least once
                sites_d,       # mean for the nb of sites each individual visited per day
                sites_tot) %>% # total nb of sites each individual visited
  
  reduce(left_join, by = "speciesEN") # all the variables are accessed at species level


# Display table 1
table_1_pub <- table_1 %>%
  mutate(monit_d   = ifelse(is.na(mean_monit_d_se), mean_monit_d, paste0(mean_monit_d, "  ", mean_monit_d_se)),
         n_detect  = ifelse(is.na(n_detect), 0, n_detect),
         n_retagged= ifelse(is.na(n_retagged ), 0, n_retagged),
         detect_d  = ifelse(is.na(mean_detect_d_se), mean_detect_d,paste0(mean_detect_d, "  ", mean_detect_d_se)),
         sites_d   = ifelse(is.na(sites_d_se), mean_sites_d,paste0(mean_sites_d, "  ", sites_d_se)),
         sites_tot = ifelse(is.na(sites_tot_se), mean_sites_tot, paste0(mean_sites_tot, "  ", sites_tot_se))) %>%
  
  left_join(data_all %>% 
              filter(!is.na(speciesSci),    # avoid error
                     !is.na(speciesEN)) %>% # avoid error
                       distinct(speciesEN, speciesSci), by = "speciesEN") %>%
  
  mutate(speciesSci = ifelse(speciesEN == "Whimbrel", "Numenius phaeopus", speciesSci)) %>%
  select(speciesEN, 
         speciesSci, 
         n_tagged, 
         n_detect,
         #n_undetect, 
         #n_retagged, 
         first_d, 
         last_d, 
         monit_d, 
         detect_d, 
         sites_d, 
         sites_tot) %>%
  
  rename(species_eng = "speciesEN",
         species_sci = "speciesSci") %>%
  arrange(first_d)


# Table 1
table_1_pub %>%
  gt() %>%
  
  tab_header(
    title = md("**Table 1.** Overview of the shorebird species VHF tracked and monitored over the local automated MOTUS array located in the Hunter estuary.")) %>%
  opt_align_table_header(align = "left") %>%
  
  tab_footnote(
    footnote = md("**Legend.** Grouped by species, this table summarises the number of shorebird individuals tagged and tracked using MOTUS-VHF technology in the Hunter estuary near Newcastle (NSW, Australia). Birds have been surveyed from the day they have been tagged (First day) to their last detection (Last day), which gives the Total of days. However, detections occurred only on certain days (Detected days). We also looked at the number of sites each species might visit per day (Nb of sites/days) and the Total number of sites the species visited during its whole survey. Dates are in dd-mm-yyyy format. Mean and standard error values are provided(xÌ„ \u00B1 SE, with SE = SD/\u221An)"))  %>%

  opt_table_font(font = "Times New Roman") %>%
  
    cols_label(
    species_eng = "Species (En.)",
    species_sci = "Species (Sci.)",
    n_tagged = "Tagged",
    n_detect = "Detected",
    #n_undetect = "Undetected",
    #n_retagged = "Re-tagged",
    first_d = "First day",
    last_d = "Last day",
    monit_d = "Total of days",
    detect_d = "Detected days",
    sites_d = "Nb of sites/days",
    sites_tot = "Total of sites" ) %>%
  
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels() ) %>%
  
  tab_style(
    style = cell_text(style = "italic"),
    locations = cells_body(columns = c(species_sci))) %>%
  
  tab_style(
    style = cell_text(whitespace = "nowrap"),
    locations = cells_body(columns = everything())) %>%
  
  tab_style(
    style = cell_text(whitespace = "nowrap"),
    locations = cells_column_labels(columns = everything())) %>%
  
  tab_options(
    table.font.size = px(16),
    heading.title.font.size = px(16),
    data_row.padding = px(3),  
    table.width = pct(100)  
  )

```

<br> <br>

And have a hint about the **conditions of detection for each species**, in the figure below *- see further details in [Station usage - hours \> Detection conditions](https://themaskou.github.io/movement_ecology_shorebirds/qmd/chapter_1/ch1_7.html#detection-conditions)*. <br>

```{r explore, message = FALSE, include = FALSE, warning = FALSE, echo = FALSE, eval = TRUE}
temp_file <- tempfile(fileext = ".R")
knitr::purl(here("qmd", "chapter_1", "ch1_7.qmd"), output = temp_file, quiet = TRUE)
source(temp_file)
```

```{r explore 2, message = FALSE, warning = FALSE, echo = FALSE, eval = TRUE}
explore
```

<br>

## Captures

### SUMMARY

Birds are trapped with mist-nets and banded. Blood and Feathers are sampled. Then a Motus tag is glued on the back of individual. Monitored for a while afterwards so we can assure his welfare. It's finally released once we confirmed the bird is behaving correctly.

Explore the below tables to get informed on the the number of birds trapped, tagged, and monitored (detected, undetected, retagged or euthanised) since 2021.

```{r 1 data overview capt, message = FALSE, warning = FALSE, eval = TRUE, echo = FALSE}

DT::datatable(
  moni,
  options = list(
    scrollX = TRUE,
    pageLength = 10,
    fixedColumns = list(leftColumns = 2)
  ),
  extensions = c('FixedColumns'),
  caption = 'Overview on birds data',
  class = 'nowrap'  
) %>%
  DT::formatStyle(
    'variable',
    fontWeight = 'bold'
  ) %>%
  DT::formatStyle(
    c('value'),
    fontWeight = 'bold',
    color = '#808080'  
  )
```

### DETAILS

With above a summarised table of the captures and the monitoring, find below the list of the birds that has been trapped, tagged and detected, attached with the **details of the capture procedures**.

```{r 1 detect, message = FALSE, warning = FALSE, eval = TRUE, echo = FALSE}

DT::datatable(
  detect,
  options = list(
    scrollX = TRUE,
    pageLength = 10,
    fixedColumns = list(leftColumns = 2)
  ),
  extensions = c('FixedColumns'),
  caption = 'Birds detected',
  class = 'nowrap'  
) %>%
  DT::formatStyle(
    c('Band.ID', 'motusTagID'),
    fontWeight = 'bold'
  ) %>%
  DT::formatStyle(
    c('speciesEN', 'DateAUS.Trap'),
    fontWeight = 'bold',
    color = '#808080'  
  )
```

## Detected

The table displays **the five last detections** (`timeAus`) for each birds.

```{r 1 table 1 indiv , message = FALSE, warning = FALSE, eval = TRUE, echo = FALSE}

data_indiv <- data_all %>% 
  select(timeAus, speciesEN, markerNumber, Band.ID, recvDeployName, recv, tideCategory,  DateAUS.Trap, motusFilter) %>%
  mutate(timeAus = format(timeAus, '%Y-%m-%d %H:%M:%S')) %>%
  group_by(Band.ID) %>%
  arrange(timeAus) %>%
  slice_tail(n = 5) %>%  # Last 5 detections per Band.ID
  ungroup()

# Markdown format
DT::datatable(
  data_indiv,
  options = list(
    scrollX = TRUE,
    pageLength = 10,
    fixedColumns = list(leftColumns = 4)),
  extensions = c('FixedColumns'),
  caption = 'See the five last detections for each tagged birds',
  class = 'nowrap'  ) %>%
  DT::formatStyle('Band.ID',
                  fontWeight = 'bold')

```

## Undetected

```{r 1 undetect, message = FALSE, warning = FALSE, eval = TRUE, echo = FALSE}

DT::datatable(
  undetect,
  options = list(
    scrollX = TRUE,
    pageLength = 10,
    fixedColumns = list(leftColumns = 2)
  ),
  extensions = c('FixedColumns'),
  caption = 'Birds never detected',
  class = 'nowrap'  
) %>%
  DT::formatStyle(
    c('Band.ID', 'motusTagID'),
    fontWeight = 'bold'
  ) %>%
  DT::formatStyle(
    c('speciesEN', 'DateAUS.Trap'),
    fontWeight = 'bold',
    color = '#808080'  
  )
```

## Retagged

```{r 1 retagged, message = FALSE, warning = FALSE, eval = TRUE, echo = FALSE}
DT::datatable(
  retag,
  options = list(
    scrollX = TRUE,
    pageLength = 10,
    fixedColumns = list(leftColumns = 2)
  ),
  extensions = c('FixedColumns'),
  caption = 'Birds re-tagged',
  class = 'nowrap'  
) %>%
  DT::formatStyle(
    c('Band.ID', 'motusTagID'),
    fontWeight = 'bold'
  ) %>%
  DT::formatStyle(
    c('speciesEN', 'DateAUS.Trap'),
    fontWeight = 'bold',
    color = '#808080'  
  )
```

## Euthanised

```{r 1 euthanised, message = FALSE, warning = FALSE, eval = TRUE, echo = FALSE}
DT::datatable(
  eutha,
  options = list(
    scrollX = TRUE,
    pageLength = 10,
    fixedColumns = list(leftColumns = 2)
  ),
  extensions = c('FixedColumns'),
  caption = 'Birds euthanised',
  class = 'nowrap'  
) %>%
  DT::formatStyle(
    c('Band.ID', 'motusTagID'),
    fontWeight = 'bold'
  ) %>%
  DT::formatStyle(
    c('speciesEN', 'DateAUS.Trap'),
    fontWeight = 'bold',
    color = '#808080'  
  )
```
