---
title: "Entropy, Eveness & Composition"
format: html
---

```{r style legend, message = FALSE, warning = FALSE, eval = TRUE, echo = FALSE, include = FALSE, results = 'hide'}
# Source the script into that environment
source(knitr::purl(here::here("qmd", "chapter_1", "ch1_3.qmd"), 
                   output = tempfile(fileext = ".R"), 
                   quiet = TRUE))  
```

::: {.callout style="border-left: 6px solid #D99B8F; --bs-callout-border: #D99B8F; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;"}
We can inform site usage for each species with its individual variation (i.e., [average number of site used per species](https://themaskou.github.io/movement_ecology_shorebirds/qmd/chapter_1/ch1_2.html#motus-table), [average rate of use for a site and depending on tidal condition](https://themaskou.github.io/movement_ecology_shorebirds/qmd/chapter_1/ch1_7.html#resident-birds)). However, the following question remaining unanswered is multiple: How loyal a bird is to his sites? Do the birds use the same sites? Is it varying at the individual and/or species level(s)? We provide two simple metrics to address this knowledge gap: **Shannon entropy** (H) and **Jensen-Shannon Divergence**(JSD).

Grouped per species, this page aims to quantify the following:

-   **Site fidelity** - Evenness equivalence- *Shannon*

    How much birds part of a same species use the same sites along time?\
    For example, if species A uses an average of five sites per day, do individual birds consistently use the same five sites over time? Does each bird always use the same five sites, or do they switch sites from day to day while still using five sites daily?\
    *Do individuals have similar entropy (H)?* *How evenly does this bird distribute its site use (J)?* *Is this potential variation occuring at species and/or individual levels?* *Is this variation tide dependant?*

-   **Site composition** - Composition difference - *Jensen-Shannon Divergence*

    Once we know whether a bird is loyal to its sites, we want to identify which sites is he loyal to.\
    For example, if Bird 1 uses sites A, B, and C, while Bird 2 uses sites C, D, and E, how to extract the site use difference between these two birds?\
    *Are individuals within a species using sites similarly?* *Is this variation tide dependant?*
:::

::: blockquote-blue
**Load your data** in your R environment *- see [Load & Format \> Reproducibility](https://themaskou.github.io/movement_ecology_shorebirds/qmd/chapter_1/ch1_1.html#reproducibility)*
:::

```{r packages,  message = FALSE, warning = FALSE, eval = TRUE, echo = TRUE}
library(motus)
library(dplyr)
library(here)
library(ggplot2)
library(tidyr)
library(readr)
library(dplyr)
library(ggplot2)
library(vegan)  
library(philentropy) 
library(gridExtra)
library(gt)
library(ggpubr)
```

```{r my data, message = FALSE, warning = FALSE, eval = TRUE, echo = FALSE, results = 'hide', include = FALSE}
# Birds
data_all <- readRDS(
  tail(sort(list.files(
    here::here("qmd", "chapter_1", "data", "motus"),
    pattern = "-data\\.rds$", full.names = TRUE
  )), 1)) 

# Receivers info
recv <- readRDS(
  tail(sort(list.files(
    here::here("qmd", "chapter_1", "data", "motus"),
    pattern = "-recv-info\\.rds$", full.names = TRUE
  )), 1)) 
```

## Shannon

### Definition

**Shannon entropy (H)** ([Shannon and Weaver -1949](https://scholar.google.com/scholar_lookup?hl=en&publication_year=1949&journal=The+mathematical+theory+of+communication&author=C.+E.+Shannon&author=W.+Weaver&title=The+mathematical+theory+of+communication); [MacArthur \* 1965](https://onlinelibrary.wiley.com/doi/epdf/10.1111/j.1469-185X.1965.tb00815.x?saml_referrer); [Lou Jost - 2006](https://nsojournals.onlinelibrary.wiley.com/doi/10.1111/j.2006.0030-1299.14714.x?utm_source=researchgate.net&utm_medium=article)) is employed when a large collection has a number of sites known -Type B collection ([Pielou - 1966](https://www.sciencedirect.com/science/article/abs/pii/0022519366900130))-, to quantify the diversity of an individual's site use. It measures the **dispersion** of an individual's site use pattern to answers: *How evenly does this bird distribute its time/detections across different sites?*

::: {style="overflow-x: auto; width: 100%;"}
$$
\text{H}   =    -Σ(p_i × ln(p_i)) 
$$ $$
\text{where } p_i \text{ is the proportion of detections at site } i
$$
:::

Low Entropy (e.g., H \< 1.0) - Individual is highly specialized\
- Uses only a few sites, or uses one site predominantly\
- High site fidelity to specific locations\
- Low unpredictability: we can predict where the bird will be

High Entropy (e.g., H \> 2.0)\
- Individual is generalized\
- Uses many sites relatively equally\
- Low site fidelity to any particular location\
- High unpredictability: harder to predict where the bird will be

**Effective Number of Sites (exp(H))** [(MacArthur - 1965)](https://onlinelibrary.wiley.com/doi/epdf/10.1111/j.1469-185X.1965.tb00815.x?saml_referrer)\
This transforms entropy into an interpretable number: the "effective number of equally-used sites"

::: {style="overflow-x: auto; width: 100%;"}
$$
\text{Effective Number of Sites}   =    exp(H) 
$$
:::

-   If H = 1.61, then exp(1.61) ≈ 5 effective sites\
-   Interpretation: The bird uses sites as if it were splitting time equally among 5 sites (even if it actually uses 10 sites, but with uneven distribution)

**Pielou's Evenness (J)** [(Pielou - 1966)](https://www.sciencedirect.com/science/article/abs/pii/0022519366900130)\
Evenness ranges from 0 to 1:\
- J close to 1: Individual uses all sites equally\
- J close to 0: Individual uses sites very unequally (dominates few sites)

::: {style="overflow-x: auto; width: 100%;"}
$$
\text{J}   =    \frac{H}{ln(S)} \text{  where } S \text{ the total number of sites used by one individual}
$$
:::

<img src="../../material/exempleshannon.png" alt="Shannon entropy example" style="max-width:100%; height:auto;"/>

First, we define a all-in-one function to consistently computing shannon entropy.

```{r shannon, message = FALSE, warning = FALSE, eval = TRUE, echo = TRUE}
# Function to calculate Shannon entropy
calculate_shannon <- function(proportions) {
  # Remove zero proportions (shouldn't be any, but safety check)
  p <- proportions[proportions > 0]
  # Calculate Shannon entropy: H = -sum(p * ln(p))
  H <- -sum(p * log(p))
  return(H)
}

```

### General results

Now we can proceed. Starting with counting the number of detection an individual has recorded in each stations, then extracting the proportions to finally calculate the entropy (H).

```{r shannon 2, message = FALSE, warning = FALSE, eval = TRUE,  echo = TRUE}

# Calculate entropy metrics for each Band.ID
entropy_results <- data_all %>%
  # Remove any NA values in Band.ID or recvSiteName
  filter(!is.na(Band.ID), !is.na(recvDeployName)) %>%
  
  # Count detections per bird per site
  group_by(speciesEN, Band.ID, recvDeployName) %>%
  summarise(detections = n(), .groups = "drop") %>%
  
  # Calculate proportions for each bird
  group_by(speciesEN, Band.ID) %>%
  mutate(
    total_detections = sum(detections),
    proportion = detections / total_detections) %>%
  
  # Calculate metrics for each bird
  summarise(
    S = n(),                                    # Number of sites used
    H = round(calculate_shannon(proportion), 2),# Shannon entropy
    J = round(H / log(S), 2),                   # Pielou's evenness
    total_detections = first(total_detections), # Total detections for reference
    .groups = "drop") %>%
  
  # Add effective number of equally-used sites
  mutate(
    exp_H = exp(H)) %>% 
  
  # Arrange by Band.ID
  arrange(speciesEN, Band.ID)

```

```{r shannon 3, message = FALSE, warning = FALSE, eval = TRUE, echo = FALSE}
# Species-level summary from entropy_results
species_entropy_summary <- entropy_results %>%
  
  group_by(speciesEN) %>%
  summarise(
    
    n_individuals = n(),
    
    # S (Number of sites) statistics
    median_S = median(S, na.rm = TRUE),
    mean_S = round(mean(S, na.rm = TRUE), 2),
    sd_S = round(sd(S, na.rm = TRUE), 2),
    
    # H (Shannon entropy) statistics
    median_H = median(H, na.rm = TRUE),
    mean_H = round(mean(H, na.rm = TRUE), 2),
    sd_H = round(sd(H, na.rm = TRUE), 2),
    CV_H = round((sd(H, na.rm = TRUE) / mean(H, na.rm = TRUE)) * 100, 1),  # Coefficient of variation
    
    # J (Pielou's evenness) statistics
    median_J = median(J, na.rm = TRUE),
    mean_J = round(mean(J, na.rm = TRUE), 2),
    sd_J = round(sd(J, na.rm = TRUE), 2),
    
    # exp_H (Effective number of sites) statistics
    median_exp_H = round(median(exp_H, na.rm = TRUE), 2),
    mean_exp_H = round(mean(exp_H, na.rm = TRUE), 2),
    sd_exp_H = round(sd(exp_H, na.rm = TRUE), 2),
    
    # Total detections across all individuals
    total_detections = sum(total_detections, na.rm = TRUE),
    
    .groups = "drop") %>%
  arrange(speciesEN)


# Result table
species_entropy_summary %>%
  
  gt() %>%
  
  tab_header(
    title = md("**Table.** Shannon entropy metrics for site use patterns of shorebird species in the Hunter estuary.")) %>%
  opt_align_table_header(align = "left") %>%
  
  tab_footnote(
    footnote = md("**Legend.** Grouped by species, this table summarises site fidelity metrics using Shannon entropy analysis. **n_individuals**: number of tagged individuals; **S**: number of unique sites used; **H**: Shannon entropy (dispersion of site use, higher = more generalised); **J**: Pielou's evenness (0-1, higher = more even site use); **exp(H)**: effective number of equally-used sites; **CV_H**: coefficient of variation in H (% individual variation within species); **total_detections**: total number of detections across all individuals. Mean and standard deviation values are provided (x̄ ± SD). Median values represent the central tendency across individuals within each species."))  %>%
  opt_table_font(font = "Times New Roman") %>%
  
  cols_label(
    speciesEN = "Species (En.)",
    n_individuals = "N individuals",
    median_S = "Median S",
    mean_S = "Mean S",
    sd_S = "SD S",
    median_H = "Median H",
    mean_H = "Mean H",
    sd_H = "SD H",
    CV_H = "CV H (%)",
    median_J = "Median J",
    mean_J = "Mean J",
    sd_J = "SD J",
    median_exp_H = "Median exp(H)",
    mean_exp_H = "Mean exp(H)",
    sd_exp_H = "SD exp(H)",
    total_detections = "Total detections" ) %>%
  
  tab_spanner(
    label = "Sample",
    columns = c(n_individuals, total_detections)) %>%
  tab_spanner(
    label = "Number of Sites (S)",
    columns = c(median_S, mean_S, sd_S) ) %>%
  tab_spanner(
    label = "Shannon Entropy (H)",
    columns = c(median_H, mean_H, sd_H, CV_H) ) %>%
  tab_spanner(
    label = "Pielou's Evenness (J)",
    columns = c(median_J, mean_J, sd_J) ) %>%
  tab_spanner(
    label = "Effective Sites [exp(H)]",
    columns = c(median_exp_H, mean_exp_H, sd_exp_H) ) %>%
  
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels() ) %>%
  tab_style(
    style = cell_text(whitespace = "nowrap"),
    locations = cells_body(columns = everything()) ) %>%
  tab_style(
    style = cell_text(whitespace = "nowrap"),
    locations = cells_column_labels(columns = everything()) ) %>%
  
  fmt_number(
    columns = c(mean_S, sd_S, mean_H, sd_H, mean_J, sd_J, mean_exp_H, sd_exp_H),
    decimals = 2) %>%
  fmt_number(
    columns = c(median_S, median_H, median_J, median_exp_H),
    decimals = 2) %>%
  fmt_number(
    columns = CV_H,
    decimals = 1) %>%
  fmt_number(
    columns = total_detections,
    decimals = 0,
    use_seps = TRUE ) %>%
  
  tab_options(
    table.font.size = px(14),
    heading.title.font.size = px(16),
    data_row.padding = px(3),  
    table.width = pct(100))

```

```{r shannon 4, message = FALSE, warning = FALSE, eval = TRUE,  echo = TRUE, results = 'hide'}
# Prepare data for plotting
entropy_for_plot <- entropy_results %>%
  select(speciesEN, Band.ID, S, H, J, exp_H) %>%
  pivot_longer(
    cols = c(S, H, J, exp_H),
    names_to = "metric",
    values_to = "value" ) %>%
  mutate( metric = factor(metric, 
                   levels = c("S", "H", "J", "exp_H"),
                   labels = c("S (Number of Sites)", 
                             "H (Shannon Entropy)", 
                             "J (Pielou's Evenness)", 
                             "exp(H) (Effective Sites)")))

# Create the boxplot
ggplot(entropy_for_plot, aes(x = speciesEN, y = value, fill = speciesEN)) +
  geom_boxplot(alpha = 0.7, outlier.shape = 16) +
  geom_jitter(width = 0.2, alpha = 0.3, size = 1) +
  facet_wrap(~ metric, scales = "free_y", ncol = 2) +
  scale_fill_manual(values = species_colors) +
  labs(
    title = "Shannon Entropy Metrics by Species",
    subtitle = "Distribution of site use patterns across individuals",
    x = "Species",
    y = "Value",
    fill = "Species") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 9),
    strip.text = element_text(face = "bold", size = 11),
    legend.position = "none",  
    panel.grid.major.x = element_blank())

```

```{r shannon 5, message = FALSE, warning = FALSE, eval = TRUE, echo = TRUE, results = 'hide', include = FALSE}

# S table
gt_S <- entropy_results %>%
  select(speciesEN, Band.ID, S) %>%
  arrange(speciesEN, Band.ID) %>%
  gt() %>%
  tab_header(title = md("**S - Number of Sites Used**")) %>%
  cols_label(speciesEN = "Species", Band.ID = "Band ID", S = "S") %>%
  tab_style(style = cell_text(weight = "bold"), locations = cells_column_labels())

# H table
gt_H <- entropy_results %>%
  select(speciesEN, Band.ID, H) %>%
  arrange(speciesEN, Band.ID) %>%
  gt() %>%
  tab_header(title = md("**H - Shannon Entropy**")) %>%
  cols_label(speciesEN = "Species", Band.ID = "Band ID", H = "H") %>%
  fmt_number(columns = H, decimals = 2) %>%
  tab_style(style = cell_text(weight = "bold"), locations = cells_column_labels())

# J table
gt_J <- entropy_results %>%
  select(speciesEN, Band.ID, J) %>%
  arrange(speciesEN, Band.ID) %>%
  gt() %>%
  tab_header(title = md("**J - Pielou's Evenness**")) %>%
  cols_label(speciesEN = "Species", Band.ID = "Band ID", J = "J") %>%
  fmt_number(columns = J, decimals = 2) %>%
  tab_style(style = cell_text(weight = "bold"), locations = cells_column_labels())

# exp_H table
gt_exp_H <- entropy_results %>%
  select(speciesEN, Band.ID, exp_H) %>%
  arrange(speciesEN, Band.ID) %>%
  gt() %>%
  tab_header(title = md("**exp(H) - Effective Number of Sites**")) %>%
  cols_label(speciesEN = "Species", Band.ID = "Band ID", exp_H = "exp(H)") %>%
  fmt_number(columns = exp_H, decimals = 2) %>%
  tab_style(style = cell_text(weight = "bold"), locations = cells_column_labels())

```

::: panel-tabset
#### S table

```{r shannon 6, message = FALSE,  warning = FALSE, echo = FALSE, eval = TRUE, results = 'asis'}
gt_S
```

#### H table

```{r shannon 7, message = FALSE,  warning = FALSE, echo = FALSE, eval = TRUE, results = 'asis'}
gt_H
```

#### J table

```{r shannon 8, message = FALSE,  warning = FALSE, echo = FALSE, eval = TRUE, results = 'asis'}
gt_J
```

#### exp(H) table

```{r shannon 9, message = FALSE,  warning = FALSE, echo = FALSE, eval = TRUE, results = 'asis'}
gt_exp_H
```
:::

### Statistical Tests

**Kruskal-Wallis test** compares entropy across species and across individual within species.\
**χ²** is provided as the test statistic to inform about the variance of the ranks among groups. The higher is the value, the more groups are different from each other. Significance is also informed.

**Test 1. Compares H, J, and S across all species: Are species different from each other?**

```{r shannon 10, message = FALSE,  warning = FALSE, echo = FALSE, eval = TRUE}
kruskal_species_H <- kruskal.test(H ~ speciesEN, data = entropy_results)
kruskal_species_J <- kruskal.test(J ~ speciesEN, data = entropy_results)
kruskal_species_S <- kruskal.test(S ~ speciesEN, data = entropy_results)

# Create a data frame with the Kruskal-Wallis results
kruskal_summary <- data.frame(
  Metric = c("H (Shannon Entropy)", 
             "J (Pielou's Evenness)", 
             "S (Number of Sites)"),
  Chi_squared = c(round(kruskal_species_H$statistic, 3),
                  round(kruskal_species_J$statistic, 3),
                  round(kruskal_species_S$statistic, 3)),
  df = c(kruskal_species_H$parameter,
         kruskal_species_J$parameter,
         kruskal_species_S$parameter),
  p_value = c(kruskal_species_H$p.value,
              kruskal_species_J$p.value,
              kruskal_species_S$p.value)) %>%
  
  mutate(
    Significance = case_when(
      p_value < 0.001 ~ "***",
      p_value < 0.01 ~ "**",
      p_value < 0.05 ~ "*",
      TRUE ~ "ns" ))

# Create the gt table
kruskal_summary %>%
  gt() %>%
  tab_header(
    title = md("**Across species: Kruskal-Wallis Test Results**"),
    subtitle = "Comparing Shannon entropy metrics across species" ) %>%
  
  cols_label(
    Metric = "Metric",
    Chi_squared = "χ²",
    df = "df",
    p_value = "p-value",
    Significance = "Sig." ) %>%
  
  fmt_number(
    columns = Chi_squared,
    decimals = 3) %>%
  
  fmt_scientific(
    columns = p_value,
    decimals = 3) %>%
  
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(
      columns = Significance,
      rows = p_value < 0.05 )) %>%
  
  tab_style(
    style = cell_fill(color = "lightgreen"),
    locations = cells_body(
      rows = p_value < 0.05 )) %>%
  
  tab_footnote(
    footnote = md("**Significance codes:** *** p < 0.001, ** p < 0.01, * p < 0.05, ns = not significant (p ≥ 0.05). Green highlighting indicates significant differences among species.") ) %>%
  
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels() ) %>%
  
  opt_table_font(font = "Times New Roman") %>%
  tab_options(
    table.font.size = px(14),
    heading.title.font.size = px(16),
    data_row.padding = px(5),
    table.width = pct(100))

```

**Test 2. Compares H and J across individuals within each species: within a species, are individuals different from each other?**

::: blockquote-yellow
Note: To proceed, we removed every species group having a size sample inferior of two. Since it is a comparison test.
:::

```{r shannon 11, message = FALSE,  warning = FALSE, echo = FALSE, eval = TRUE}

library(gt)
library(dplyr)

# Filter species with at least 3 individuals (Kruskal-Wallis needs at least 3 groups)
species_with_multiple_birds <- entropy_results %>%
  group_by(speciesEN) %>%
  filter(n() >= 3) %>%
  ungroup()

# Run Kruskal-Wallis for each species separately
kruskal_within_species <- species_with_multiple_birds %>%
  group_by(speciesEN) %>%
  summarise(
    n_individuals = n(),
    
    # H (Shannon Entropy)
    Chi_sq_H = kruskal.test(H ~ Band.ID)$statistic,
    df_H = kruskal.test(H ~ Band.ID)$parameter,
    p_value_H = kruskal.test(H ~ Band.ID)$p.value,
    
    # J (Pielou's Evenness)
    Chi_sq_J = kruskal.test(J ~ Band.ID)$statistic,
    df_J = kruskal.test(J ~ Band.ID)$parameter,
    p_value_J = kruskal.test(J ~ Band.ID)$p.value,
    
    # S (Number of Sites)
    Chi_sq_S = kruskal.test(S ~ Band.ID)$statistic,
    df_S = kruskal.test(S ~ Band.ID)$parameter,
    p_value_S = kruskal.test(S ~ Band.ID)$p.value,
    
    .groups = "drop"
  ) %>%
  mutate(
    Sig_H = case_when(
      p_value_H < 0.001 ~ "***",
      p_value_H < 0.01 ~ "**",
      p_value_H < 0.05 ~ "*",
      TRUE ~ "ns"
    ),
    Sig_J = case_when(
      p_value_J < 0.001 ~ "***",
      p_value_J < 0.01 ~ "**",
      p_value_J < 0.05 ~ "*",
      TRUE ~ "ns"
    ),
    Sig_S = case_when(
      p_value_S < 0.001 ~ "***",
      p_value_S < 0.01 ~ "**",
      p_value_S < 0.05 ~ "*",
      TRUE ~ "ns"
    )
  )

# Create the gt table
kruskal_within_species %>%
  
  gt() %>%
  
  tab_header(
    title = md("**Within Species: Kruskal-Wallis Test Results**"),
    subtitle = "Comparing entropy metrics across individuals within each species") %>%
  
  cols_label(
    speciesEN = "Species",
    n_individuals = "N",
    Chi_sq_H = "χ²",
    df_H = "df",
    p_value_H = "p-value",
    Sig_H = "Sig.",
    Chi_sq_J = "χ²",
    df_J = "df",
    p_value_J = "p-value",
    Sig_J = "Sig.",
    Chi_sq_S = "χ²",
    df_S = "df",
    p_value_S = "p-value",
    Sig_S = "Sig.") %>%
  
  tab_spanner(
    label = "H (Shannon Entropy)",
    columns = c(Chi_sq_H, df_H, p_value_H, Sig_H)) %>%
  tab_spanner(
    label = "J (Pielou's Evenness)",
    columns = c(Chi_sq_J, df_J, p_value_J, Sig_J)) %>%
  tab_spanner(
    label = "S (Number of Sites)",
    columns = c(Chi_sq_S, df_S, p_value_S, Sig_S)) %>%
  
  fmt_number(
    columns = c(Chi_sq_H, Chi_sq_J, Chi_sq_S),
    decimals = 3) %>%
  
  fmt_scientific(
    columns = c(p_value_H, p_value_J, p_value_S),
    decimals = 3) %>%
  
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(
      columns = c(Sig_H, Sig_J, Sig_S),
      rows = p_value_H < 0.05 | p_value_J < 0.05 | p_value_S < 0.05 )) %>%
  
  tab_style(
    style = cell_fill(color = "lightgreen"),
    locations = cells_body(
      columns = c(Chi_sq_H, df_H, p_value_H, Sig_H),
      rows = p_value_H < 0.05 )) %>%
  tab_style(
    style = cell_fill(color = "lightblue"),
    locations = cells_body(
      columns = c(Chi_sq_J, df_J, p_value_J, Sig_J),
      rows = p_value_J < 0.05 ) ) %>%
  tab_style(
    style = cell_fill(color = "lightyellow"),
    locations = cells_body(
      columns = c(Chi_sq_S, df_S, p_value_S, Sig_S),
      rows = p_value_S < 0.05 ) ) %>%
  
  tab_footnote(
    footnote = md("**Significance codes:** *** p < 0.001, ** p < 0.01, * p < 0.05, ns = not significant (p ≥ 0.05). **N** = number of individuals. Green/blue/yellow highlighting indicates significant differences among individuals within that species. Only species with ≥3 individuals are included (minimum requirement for Kruskal-Wallis test).") ) %>%
  
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels() ) %>%
  
  opt_table_font(font = "Times New Roman") %>%
  
  tab_options(
    table.font.size = px(13),
    heading.title.font.size = px(16),
    data_row.padding = px(4),
    table.width = pct(100))

```

### Tidal dependant results

We now want to clarify whether birds associate **site fidelity** depending the tide, therefore likely depending their behavior (i.e., foraging **vs** roosting).

```{r shannon tide 1, message = FALSE, warning = FALSE, eval = TRUE,  echo = TRUE, results = 'hide'}

# Calculate entropy metrics for each Band.ID
entropy_results_tide <- data_all %>%
  # Remove any NA values in Band.ID or recvSiteName
  filter(!is.na(Band.ID), !is.na(recvDeployName)) %>%
  
  # Count detections per bird per site
  group_by(speciesEN, Band.ID, recvDeployName, tideHighLow) %>%
  summarise(detections = n(), .groups = "drop") %>%
  
  # Calculate proportions for each bird
  group_by(speciesEN, Band.ID, tideHighLow) %>%
  mutate(
    total_detections = sum(detections),
    proportion = detections / total_detections) %>%
  
  # Calculate metrics for each bird
  summarise(
    S = n(),                                              # Number of sites used
    H = round(calculate_shannon(proportion), 2),          # Shannon entropy
    J = round(H / log(S), 2),                             # Pielou's evenness
    total_detections = first(total_detections),           # Total detections for reference
    .groups = "drop") %>%
  
  # Add effective number equally-used sites
  mutate(
    exp_H = exp(H)) %>%

  
  # Arrange by Band.ID
  arrange(speciesEN, Band.ID, tideHighLow)

```

```{r shannon tide 2, message = FALSE, warning = FALSE, eval = TRUE, echo = FALSE}
# Species-level summary from entropy_results
species_entropy_summary_tide <- entropy_results_tide %>%
  group_by(speciesEN, tideHighLow) %>%
  summarise(
    n_individuals = n(),
    
    # S (Number of sites) statistics
    median_S = median(S, na.rm = TRUE),
    mean_S = round(mean(S, na.rm = TRUE), 2),
    sd_S = round(sd(S, na.rm = TRUE), 2),
    
    # H (Shannon entropy) statistics
    median_H = median(H, na.rm = TRUE),
    mean_H = round(mean(H, na.rm = TRUE), 2),
    sd_H = round(sd(H, na.rm = TRUE), 2),
    CV_H = round((sd(H, na.rm = TRUE) / mean(H, na.rm = TRUE)) * 100, 1),  # Coefficient of variation
    
    # J (Pielou's evenness) statistics
    median_J = median(J, na.rm = TRUE),
    mean_J = round(mean(J, na.rm = TRUE), 2),
    sd_J = round(sd(J, na.rm = TRUE), 2),
    
    # exp_H (Effective number of sites) statistics
    median_exp_H = round(median(exp_H, na.rm = TRUE), 2),
    mean_exp_H = round(mean(exp_H, na.rm = TRUE), 2),
    sd_exp_H = round(sd(exp_H, na.rm = TRUE), 2),
    
    # Total detections across all individuals
    total_detections = sum(total_detections, na.rm = TRUE),
    
    .groups = "drop") %>%
  
  arrange(speciesEN)

```

```{r shannon tide 3, message = FALSE, warning = FALSE, eval = TRUE,  echo = TRUE}
# Prepare data
entropy_for_plot_tide <- entropy_results_tide %>%
  select(speciesEN, tideHighLow, Band.ID, S, H, J, exp_H) %>%
  pivot_longer(
    cols = c(S, H, J, exp_H),
    names_to = "metric",
    values_to = "value" ) %>%
  mutate( 
    metric = factor(metric, 
                   levels = c("S", "H", "J", "exp_H"),
                   labels = c("S (Number of Sites)", 
                             "H (Shannon Entropy)", 
                             "J (Pielou's Evenness)", 
                             "exp(H) (Effective Sites)")) )

# Compute t-tets
tide_tests <- entropy_for_plot_tide %>%
  group_by(speciesEN, metric) %>%
  summarise(
    n_high = sum(tideHighLow == "High"),
    n_low = sum(tideHighLow == "Low"),
    # Use t-test if n >= 3 in both groups, otherwise skip
    p_value = if(n_high >= 3 & n_low >= 3) {
      t.test(value ~ tideHighLow)$p.value
    } else {
      NA
    },
    test_used = if(n_high >= 3 & n_low >= 3) "t-test" else "insufficient data",
    .groups = "drop"
  ) %>%
  mutate(
    significance = case_when(
      is.na(p_value) ~ "",
      p_value < 0.001 ~ "***",
      p_value < 0.01 ~ "**",
      p_value < 0.05 ~ "*",
      TRUE ~ "ns"  ))
```

```{r shannon tide 4, message = FALSE, warning = FALSE, eval = TRUE,  echo = TRUE}
ggplot(entropy_for_plot_tide, aes(x = speciesEN, y = value, fill = speciesEN, alpha = tideHighLow)) +
  geom_boxplot(aes(group = interaction(speciesEN, tideHighLow)), 
               position = position_dodge(width = 0.8), 
               outlier.shape = 16) +
  geom_point(aes(group = interaction(speciesEN, tideHighLow)),
           position = position_jitterdodge(jitter.width = 0.1, dodge.width = 0.8), 
           size = 1.1) +
  facet_wrap(~ metric, scales = "free_y", ncol = 2) +
  scale_fill_manual(values = species_colors) +
  scale_alpha_manual( values = c("High" = 1.0, "Low" = 0.2)) +
  
  # Add significance brackets
  stat_compare_means(
    aes(group = tideHighLow),
    method = "t.test",
    label = "p.signif",
    hide.ns = TRUE,
    size = 3,
    bracket.size = 0.3) +
  labs(
    title = "Shannon Entropy Metrics by Species and Tide",
    subtitle = "Distribution of site use patterns across individuals and tide (High tide: solid, Low tide: transparent)",
    x = "Species",
    y = "Value",
    fill = "Species") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 9),
    strip.text = element_text(face = "bold", size = 11),
    legend.position = "none",
    panel.grid.major.x = element_blank())
```

See below t-test results which compare entropy values between low and high tides for each species.

```{r shannon tide 5, message = FALSE, warning = FALSE, eval = TRUE,  echo = FALSE}
tide_tests %>%
  
  select(speciesEN, metric, n_high, n_low, p_value, significance) %>%
  pivot_wider(
    id_cols = speciesEN,
    names_from = metric,
    values_from = c(p_value, significance),
    names_glue = "{metric}_{.value}") %>%
  
  gt() %>%
  
  tab_header(
    title = md("**T-test Results: High vs Low Tide Comparison**")) %>%

  cols_label(
    speciesEN = "Species",
    `S (Number of Sites)_p_value` = "p-value",
    `S (Number of Sites)_significance` = "Sig.",
    `H (Shannon Entropy)_p_value` = "p-value",
    `H (Shannon Entropy)_significance` = "Sig.",
    `J (Pielou's Evenness)_p_value` = "p-value",
    `J (Pielou's Evenness)_significance` = "Sig.",
    `exp(H) (Effective Sites)_p_value` = "p-value",
    `exp(H) (Effective Sites)_significance` = "Sig.") %>%
  
  tab_spanner(
    label = "S (Number of Sites)",
    columns = c(`S (Number of Sites)_p_value`, `S (Number of Sites)_significance`)  ) %>%
  
  tab_spanner(
    label = "H (Shannon Entropy)",
    columns = c(`H (Shannon Entropy)_p_value`, `H (Shannon Entropy)_significance`)) %>%
  
  tab_spanner(
    label = "J (Pielou's Evenness)",
    columns = c(`J (Pielou's Evenness)_p_value`, `J (Pielou's Evenness)_significance`)) %>%
  
  tab_spanner(
    label = "exp(H) (Effective Sites)",
    columns = c(`exp(H) (Effective Sites)_p_value`, `exp(H) (Effective Sites)_significance`)) %>%
  
  fmt_scientific(
    columns = contains("_p_value"),
    decimals = 3) %>%
  
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(
      columns = contains("_significance") )) %>%
  
  tab_style(
    style = cell_fill(color = "lightgreen"),
    locations = cells_body(
      columns = contains("_p_value"),
      rows = `S (Number of Sites)_p_value` < 0.05 | 
             `H (Shannon Entropy)_p_value` < 0.05 | 
             `J (Pielou's Evenness)_p_value` < 0.05 | 
             `exp(H) (Effective Sites)_p_value` < 0.05)) %>%
  
  tab_style(
    style = cell_fill(color = "lightgreen"),
    locations = cells_body(
      columns = contains("_significance"),
      rows = `S (Number of Sites)_p_value` < 0.05 | 
             `H (Shannon Entropy)_p_value` < 0.05 | 
             `J (Pielou's Evenness)_p_value` < 0.05 | 
             `exp(H) (Effective Sites)_p_value` < 0.05)) %>%
  
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels()) %>%
  
  tab_style(
    style = cell_text(whitespace = "nowrap"),
    locations = cells_body(columns = everything())) %>%
  
  tab_style(
    style = cell_text(whitespace = "nowrap"),
    locations = cells_column_labels(columns = everything())) %>%
  
  tab_footnote(
    footnote = md("**Significance codes:** *** p < 0.001, ** p < 0.01, * p < 0.05, ns = not significant. T-tests compare mean values between High and Low tide for each species-metric combination. Green highlighting indicates significant differences (p < 0.05).")) %>%
  
  opt_table_font(font = "Times New Roman") %>%
  
  tab_options(
    table.font.size = px(13),
    heading.title.font.size = px(16),
    data_row.padding = px(3),
    table.width = pct(100))
```

Now, we displayed below for each species their associated entropy metrics, side by side with high and low tides so we can easily compare the values and report to the boxplot above.

```{r shannon tide 6, message = FALSE, warning = FALSE, eval = TRUE,  echo = FALSE}

# Result table with tideHighLow grouping
species_entropy_summary_tide %>%
  
  gt() %>%
  
  tab_header(
    title = md("**Table.** Shannon entropy metrics for site use patterns of shorebird species by tide state in the Hunter estuary.")) %>%
  opt_align_table_header(align = "left") %>%
  
  tab_footnote(
    footnote = md("**Legend.** Grouped by species and tide state (Low/High), this table summarises site fidelity metrics using Shannon entropy analysis. **tideHighLow**: tide state during detections (Low or High tide); **n_individuals**: number of tagged individuals; **S**: number of unique sites used; **H**: Shannon entropy (dispersion of site use, higher = more generalised); **J**: Pielou's evenness (0-1, higher = more even site use); **exp(H)**: effective number of equally-used sites; **CV_H**: coefficient of variation in H (% individual variation within species); **total_detections**: total number of detections across all individuals. Mean and standard deviation values are provided (x̄ ± SD). Median values represent the central tendency across individuals within each species."))  %>%
  opt_table_font(font = "Times New Roman") %>%
  
  cols_label(
    speciesEN = "Species",
    tideHighLow = "Tide",
    n_individuals = "N indiv.",
    median_S = "Median",
    mean_S = "Mean",
    sd_S = "SD",
    median_H = "Median",
    mean_H = "Mean",
    sd_H = "SD",
    CV_H = "CV (%)",
    median_J = "Median",
    mean_J = "Mean",
    sd_J = "SD",
    median_exp_H = "Median",
    mean_exp_H = "Mean",
    sd_exp_H = "SD",
    total_detections = "Total det." ) %>%
  
  tab_spanner(
    label = "Sample",
    columns = c(n_individuals, total_detections)) %>%
  tab_spanner(
    label = "Number of Sites (S)",
    columns = c(median_S, mean_S, sd_S) ) %>%
  tab_spanner(
    label = "Shannon Entropy (H)",
    columns = c(median_H, mean_H, sd_H, CV_H) ) %>%
  tab_spanner(
    label = "Pielou's Evenness (J)",
    columns = c(median_J, mean_J, sd_J) ) %>%
  tab_spanner(
    label = "Effective Sites [exp(H)]",
    columns = c(median_exp_H, mean_exp_H, sd_exp_H) ) %>%
  
  # Row grouping by species
  tab_row_group(
    label = "Bar-tailed Godwit",
    rows = speciesEN == "Bar-tailed Godwit" ) %>%
  tab_row_group(
    label = "Curlew Sandpiper",
    rows = speciesEN == "Curlew Sandpiper") %>%
  tab_row_group(
    label = "Eurasian Whimbrel",
    rows = speciesEN == "Eurasian Whimbrel") %>%
  tab_row_group(
    label = "Far Eastern Curlew",
    rows = speciesEN == "Far Eastern Curlew") %>%
  tab_row_group(
    label = "Masked Lapwing",
    rows = speciesEN == "Masked Lapwing") %>%
  tab_row_group(
    label = "Pacific Golden-Plover",
    rows = speciesEN == "Pacific Golden-Plover") %>%
  tab_row_group(
    label = "Pied Stilt",
    rows = speciesEN == "Pied Stilt") %>%
  tab_row_group(
    label = "Red-necked Avocet",
    rows = speciesEN == "Red-necked Avocet") %>%
  
  # Hide the speciesEN column since it's now in row groups
  cols_hide(columns = speciesEN) %>%
  
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels() ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_row_groups() ) %>%
  tab_style(
    style = cell_text(whitespace = "nowrap"),
    locations = cells_body(columns = everything()) ) %>%
  tab_style(
    style = cell_text(whitespace = "nowrap"),
    locations = cells_column_labels(columns = everything()) ) %>%
  
  # Alternate row colors by tide within each species
  tab_style(
    style = cell_fill(color = "#F0F8FF"),
    locations = cells_body(rows = tideHighLow == "Low")) %>%
  tab_style(
    style = cell_fill(color = "#FFF8DC"),
    locations = cells_body(rows = tideHighLow == "High")) %>%
  
  fmt_number(
    columns = c(mean_S, sd_S, mean_H, sd_H, mean_J, sd_J, mean_exp_H, sd_exp_H),
    decimals = 2) %>%
  fmt_number(
    columns = c(median_S, median_H, median_J, median_exp_H),
    decimals = 2) %>%
  fmt_number(
    columns = CV_H,
    decimals = 1) %>%
  fmt_number(
    columns = total_detections,
    decimals = 0,
    use_seps = TRUE ) %>%
  
  tab_options(
    table.font.size = px(13),
    heading.title.font.size = px(16),
    data_row.padding = px(3),  
    table.width = pct(100),
    row_group.font.weight = "bold")
```

## Jensen-Shannon Divergence

### Definition

Now we know how loyal individuals are to their sites and whether there are differences across species in term of site fidelity (H), we also put against this metric the evenness which describes whether a bird use multiple site but effectively use a few (J).

We know want to dive deeper and clarify whether birds use the same sites within the same species, regardless the number of sites. Then, we called another metric named Jensen-Shannon Divergence (JSD), which quantifies how different two probability distributions are, answering whether two individuals are using the same composition of sites.\
JSD is defined with the simplified formula here below:

::: {style="overflow-x: auto; width: 100%;"}
$$
\text{JSD}(P∥Q)  =  H(M) - \frac{H(P) + H(Q)}{2}
$$

$$
\text{where } Q \text{ and  } P \text{ the site use distributions for two individuals; } M \text{ the mixture (average) site distribution; and } H \text{ the Shannon entropy} 
$$
:::

JSD ≈ 0 (Similarity ≈ 1.0)\
- Individuals use sites in nearly identical proportions\
- High overlap in site use patterns\
- Suggests shared habitat preferences or social coordination

JSD ≈ 1.0 (Similarity ≈ 0)\
- Individuals use completely different sets of sites or proportions\
- Low overlap in site use patterns\
- Suggests individual specialization or territoriality

### General results

First, we set a function that will compute the JSD metric for later in the process.

```{r jensen-shannon, message = FALSE, warning = FALSE, eval = TRUE, echo = TRUE}
# Function to calculate Jensen-Shannon Divergence
calculate_jsd <- function(p, q) {
  # Add small value to avoid log(0)
  epsilon <- 1e-10
  p <- p + epsilon
  q <- q + epsilon
  
  # Normalise
  p <- p / sum(p)
  q <- q / sum(q)
  
  # Calculate JSD
  m <- (p + q) / 2
  jsd <- 0.5 * sum(p * log2(p / m)) + 0.5 * sum(q * log2(q / m))
  
  return(jsd)
}
```

Second, we need to prepare the data frame which will be used for calculation. It must include for each individual its proportion of site used and its total. Then, we can proceed and extract JSD for each pair of individuals. Indeed, JSD test the similarity between two individual, so it conducts a pairwise test.

```{r jensen-shannon 2, message = FALSE, warning = FALSE, eval = TRUE, echo = TRUE}

# Create site use matrix (rows = individuals, columns = sites)
site_use_matrix <- data_all %>%
  filter(!is.na(Band.ID), !is.na(recvDeployName)) %>%
  group_by(Band.ID, recvDeployName) %>%
  summarise(detections = n(), .groups = "drop") %>%
  group_by(Band.ID) %>%
  mutate(proportion = round(detections / sum(detections), 2)) %>%
  select(Band.ID, recvDeployName, proportion) %>%
  pivot_wider(
    names_from = recvDeployName,
    values_from = proportion,
    values_fill = 0)

# Calculate pairwise JSD
individual_ids <- site_use_matrix$Band.ID
n_individuals <- length(individual_ids)

jsd_results <- data.frame()

for (i in 1:(n_individuals - 1)) {
  for (j in (i + 1):n_individuals) {
    
    p <- as.numeric(site_use_matrix[i, -1])
    q <- as.numeric(site_use_matrix[j, -1])
    
    jsd_results <- rbind(jsd_results, data.frame(
      Band.ID_1 = individual_ids[i],
      Band.ID_2 = individual_ids[j],
      JSD = round(calculate_jsd(p, q), 3),
      Similarity = round(1 - calculate_jsd(p, q), 3)))
  }
}

# Add species information
jsd_results <- jsd_results %>%
  left_join(data_all %>% select(Band.ID, speciesEN) %>% distinct(), 
            by = c("Band.ID_1" = "Band.ID")) %>%
  rename(species_1 = speciesEN) %>%
  left_join(data_all %>% select(Band.ID, speciesEN) %>% distinct(), 
            by = c("Band.ID_2" = "Band.ID")) %>%
  rename(species_2 = speciesEN) %>%
  mutate(same_species = species_1 == species_2)

```

We can summarise the results to better handle visualisations.

```{r jensen-shannon 3, message = FALSE, warning = FALSE, eval = TRUE, echo = TRUE}
jsd_results_tab <- jsd_results %>%
  filter(same_species == TRUE) %>%
  group_by(species_1) %>%
  summarise(
    n_comparisons = n(),
    mean_JSD = round(mean(JSD), 3),
    sd_JSD = round(sd(JSD), 3),
    mean_Similarity = round(mean(Similarity), 3),
    sd_Similarity = round(sd(Similarity), 3),
    .groups = "drop") %>%
  rename(speciesEN = species_1)


n_indiv <- data_all %>%
  group_by(speciesEN) %>%
  summarise(n_indiv = n_distinct(Band.ID), .groups = "drop")
jsd_results_tab <- jsd_results_tab %>%
  left_join(n_indiv, by = "speciesEN") %>%
  select(speciesEN, n_indiv, everything()) %>%
  arrange(mean_JSD)

```

```{r jensen-shannon 31, message = FALSE, warning = FALSE, eval = TRUE, echo = TRUE}

# Filter to same_species comparisons and prepare for boxplot (matching entropy_for_plot structure)
jsd_for_plot <- jsd_results %>%
  
  filter(same_species == TRUE) %>%
  
  mutate(
    metric = "JSD",
    speciesEN = species_1) %>% 
  
  select(speciesEN, JSD, metric) %>%
  rename(value = JSD)

# Boxplot exactly matching your entropy format
ggplot(jsd_for_plot, aes(x = speciesEN, y = value, fill = speciesEN)) +
  
  geom_boxplot(alpha = 0.7, outlier.shape = 16) +
  geom_jitter(width = 0.2, alpha = 0.3, size = 1) +
  
  scale_fill_manual(values = species_colors) +
  
  labs(
    title = "Jensen-Shannon Divergence by Species",
    subtitle = "Individual pairwise similarity within species",
    x = "Species",
    y = "JSD Value",
    fill = "Species") +
  
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 9),
    strip.text = element_text(face = "bold", size = 11),
    legend.position = "none",  
    panel.grid.major.x = element_blank())


```

```{r jensen-shannon 32, message = FALSE, warning = FALSE, eval = TRUE, echo = FALSE}

jsd_results_tab %>%
  gt()

```

### Statistical Tests

We will use **Kruskal-Wallis** test if the distributions of JSD differ among species. It is a non-parametric (doesn't assume normal distribution), it handles unequal sample sizes (different number of comparisons per species).

```{r jensen-shannon 4, message = FALSE, warning = FALSE, eval = TRUE, echo = FALSE}
kruskal_value <- kruskal.test(JSD ~ species_1, 
                            data = jsd_results %>% filter(same_species == TRUE))

kruskal_summary <- data.frame(
  Metric = c("Value"),
  Chi_squared = round(kruskal_value$statistic, 3),
  df = kruskal_value$parameter,
  p_value = kruskal_value$p.value) %>%
  mutate(
    Significance = case_when(
      p_value < 0.001 ~ "***",
      p_value < 0.01 ~ "**",
      p_value < 0.05 ~ "*",
      TRUE ~ "ns"))

kruskal_summary  %>%
  
  gt() %>%
  
  tab_header(
    title = md("**Kruskal-Wallis Test Results**"),
    subtitle = "Comparing value across groups") %>%
  
  cols_label(
    Metric = "Metric",
    Chi_squared = "χ2",
    df = "df",
    p_value = "p-value",
    Significance = "Sig.") %>% 
  
  fmt_number(
    columns = Chi_squared,
    decimals = 3) %>%
  
  fmt_scientific(
    columns = p_value,
    decimals = 3) %>%
  
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(
      columns = Significance,
      rows = p_value < 0.05)) %>%
  
  tab_style(
    style = cell_fill(color = "lightgreen"),
    locations = cells_body(
      rows = p_value < 0.05)) %>%
  
  tab_footnote(
    footnote = md("**Significance codes:** *** p < 0.001, ** p < 0.01, * p < 0.05, ns = not significant (p ≥ 0.05). Green highlighting indicates significant differences.")) %>%
  
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels()) %>%
  
  opt_table_font(font = "Times New Roman") %>%
  
  tab_options(
    table.font.size = px(14),
    heading.title.font.size = px(16),
    data_row.padding = px(5),
    table.width = pct(100)
  )


```

In the aim to observe which species significantly differs from another in term of individual co;position of site used, we need to conduct pairwise test across species. We used the **Dunn method** [Dunn - 1964](https://www.tandfonline.com/doi/abs/10.1080/00401706.1964.10490181) which applies a **Bonferroni correction** to extract the false positive from JSD significance. The Bonferroni correction adjusts for this by dividing the significance level by the number of tests ([Bonferroni -](https://wwwnc.cdc.gov/eid/article/21/2/ET-2102_article)).

```{r jensen-shannon 5, message = FALSE, warning = FALSE, eval = TRUE, echo = TRUE, results = 'hide'}

# If significant, do post-hoc pairwise comparisons
if(kruskal_value$p.value < 0.05) {
  library(FSA)
  dunn_jsd <- dunnTest(JSD ~ species_1, 
                       data = jsd_results %>% filter(same_species == TRUE),
                       method = "bonferroni")
  print(dunn_jsd)
}

```

```{r jensen-shannon 6, message = FALSE, warning = FALSE, eval = TRUE, echo = FALSE}

dunn_jsd_table <- dunn_jsd$res %>%
  mutate(
    Significance = case_when(
      P.adj < 0.001 ~ "***",
      P.adj < 0.01 ~ "**",
      P.adj < 0.05 ~ "*",
      TRUE ~ "ns"
    )
  ) %>%
  select(Comparison, Z, P.unadj, P.adj, Significance)  # Adjust columns as needed

dunn_jsd_table %>% 
  
  arrange(Comparison) %>%
  
  gt() %>%
  
  tab_header(
    title = md("**Bonferroni Correction Post-Hoc Test (Dunn)**"),
    subtitle = "Pairwise JSD comparisons across species") %>%
  
  cols_label(
    Comparison = "Comparison",
    Z = "Z",
    P.unadj = "p unadj",
    P.adj = "p adj",
    Significance = "Sig.") %>%
  
  fmt_scientific(
    columns = c(P.unadj, P.adj),
    decimals = 3) %>%
  
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(
      columns = Significance,
      rows = P.adj < 0.05)) %>%
  tab_style(
    style = cell_fill(color = "lightgreen"),
    locations = cells_body(
      rows = P.adj < 0.05)) %>%
  
  tab_footnote(
    footnote = md("**Significance codes:** *** p < 0.001, ** p < 0.01, * p < 0.05, ns = not significant. Green = significant. **p unadj** and **p adj** the raw and Bonferroni corrected p-values.")) %>%
  
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels()) %>%
  
  opt_table_font(font = "Times New Roman") %>%
  
  tab_options(
    table.font.size = px(14),
    heading.title.font.size = px(16),
    data_row.padding = px(5),
    table.width = pct(100))

```

The table above shows which species are truly using **different** sites than another. Jensen-Shannon Distance measures dissimilarity in site-use composition between species pairs. Higher JSD goes with more different site used. The Dunn test then confirms if those differences are statistically real after Bonferroni correction.

### Tidal dependant results

We now want to clarify whether birds associate **site composition** depending the tide, therefore likely depending their behavior (i.e., foraging **vs** roosting).

Applying the same method as before, we display below the results depending the tide.

```{r jensen-shannon tide 2, message = FALSE, warning = FALSE, eval = TRUE, echo = FALSE}

# Step 1: Create site use matrix (rows = individuals, columns = sites)
site_use_matrix_tide<- data_all %>%
  filter(!is.na(Band.ID), !is.na(recvDeployName)) %>%
  group_by(Band.ID, recvDeployName, tideHighLow) %>%
  summarise(detections = n(), .groups = "drop") %>%
  group_by(Band.ID, tideHighLow) %>%
  mutate(proportion = round(detections / sum(detections), 2)) %>%
  select(Band.ID, recvDeployName, tideHighLow, proportion) %>%
  pivot_wider(
    names_from = recvDeployName,
    values_from = proportion,
    values_fill = 0) %>%
  unite("id_tide", Band.ID, tideHighLow, remove = FALSE)  # Unique ID for each individual*tide combo

# Step 2: Calculate pairwise JSD
individual_tide_ids <- site_use_matrix_tide$id_tide
n_individuals_tide <- length(individual_tide_ids)

jsd_results_tide <- data.frame()

for (i in 1:(n_individuals_tide - 1)) {
  for (j in (i + 1):n_individuals_tide) {
    
    # Only compare birds with same tideHighLow
    if (site_use_matrix_tide$tideHighLow[i] == site_use_matrix_tide$tideHighLow[j]) {
      p <- as.numeric(site_use_matrix_tide[i, -c(1:3)])  # Exclude ID columns
      q <- as.numeric(site_use_matrix_tide[j, -c(1:3)])
      
      jsd_results_tide <- rbind(jsd_results_tide, data.frame(
        Band.ID_1 = site_use_matrix_tide$Band.ID[i],
        Band.ID_2 = site_use_matrix_tide$Band.ID[j],
        tideHighLow = site_use_matrix_tide$tideHighLow[i],
        JSD = round(calculate_jsd(p, q), 3),
        Similarity = round(1 - calculate_jsd(p, q), 3)))
    }
  }
}

# Step 3: Add species information
jsd_results_tide <- jsd_results_tide %>%
  left_join(data_all %>% select(Band.ID, speciesEN) %>% distinct(), 
            by = c("Band.ID_1" = "Band.ID")) %>%
  rename(species_1 = speciesEN) %>%
  left_join(data_all %>% select(Band.ID, speciesEN) %>% distinct(), 
            by = c("Band.ID_2" = "Band.ID")) %>%
  rename(species_2 = speciesEN) %>%
  mutate(same_species = species_1 == species_2) %>%
  filter(same_species == TRUE)  # Only conspecific comparisons

```

```{r jensen-shannon tide 3, message = FALSE, warning = FALSE, eval = TRUE, echo = FALSE}

jsd_results_tab_tide <- jsd_results_tide %>%
  filter(same_species == TRUE) %>%
  group_by(species_1, tideHighLow) %>%
  summarise(
    n_comparisons = n(),
    mean_JSD = round(mean(JSD), 3),
    sd_JSD = round(sd(JSD), 3),
    mean_Similarity = round(mean(Similarity), 3),
    sd_Similarity = round(sd(Similarity), 3),
    .groups = "drop") %>%
  rename(speciesEN = species_1)

n_indiv <- data_all %>%
  group_by(speciesEN, tideHighLow) %>%
  summarise(n_indiv = n_distinct(Band.ID), .groups = "drop")
jsd_results_tab_tide <- jsd_results_tab_tide %>%
  left_join(n_indiv, by = c("speciesEN", "tideHighLow")) %>%
  select(speciesEN, tideHighLow, n_indiv, n_comparisons, mean_JSD, sd_JSD, 
         mean_Similarity, sd_Similarity) %>%
  arrange(tideHighLow, mean_JSD)
```

```{r jensen-shannon tide 31, message = FALSE, warning = FALSE, eval = TRUE, echo = FALSE}

jsd_results_tab_tide %>%
  gt() %>%
  tab_header(
    title = md("**Table.** Jensen-Shannon Divergence (JSD) for intra-species habitat similarity by tide state in the Hunter estuary."),
    subtitle = md("Lower JSD = greater similarity in site use patterns between individuals within species") ) %>%

  tab_footnote(
    footnote = md("**Legend.** **n_indiv**: tagged individuals per species×tide combination; **n_comparisons**: pairwise comparisons; **mean_JSD ± sd_JSD**: average dissimilarity in site used; **mean_Similarity ± sd_Similarity**: 1/JSD (average site used similarity). **Low tide** rows blue, **High tide** rows yellow.")) %>%
  opt_table_font(font = "Times New Roman") %>%
  
  cols_label(
    speciesEN = "Species",
    tideHighLow = "Tide", 
    n_indiv = "N indiv.",
    n_comparisons = "N comp.",
    mean_JSD = "Mean",
    sd_JSD = "SD",
    mean_Similarity = "Mean",
    sd_Similarity = "SD") %>%
  
  tab_spanner(
    label = "Sample Size",
    columns = c(n_indiv, n_comparisons) ) %>%
  tab_spanner(
    label = "JSD (Dissimilarity)",
    columns = c(mean_JSD, sd_JSD) ) %>%
  tab_spanner(
    label = "Similarity (1/JSD)",
    columns = c(mean_Similarity, sd_Similarity) ) %>%
  
  # Row grouping by species (update with your actual species names)
  tab_row_group(
    label = "Bar-tailed Godwit",
    rows = speciesEN == "Bar-tailed Godwit" ) %>%
  tab_row_group(
    label = "Pied Stilt", 
    rows = speciesEN == "Pied Stilt") %>%
  tab_row_group(
    label = "Pacific Golden-Plover",
    rows = speciesEN == "Pacific Golden-Plover" ) %>%
  tab_row_group(
    label = "Red-necked Avocet",
    rows = speciesEN == "Red-necked Avocet" ) %>%
  tab_row_group(
    label = "Curlew Sandpiper",
    rows = speciesEN == "Curlew Sandpiper") %>%
  tab_row_group(
    label = "Eurasian Whimbrel",
    rows = speciesEN == "Eurasian Whimbrel" ) %>%
  
  cols_hide(columns = speciesEN) %>%
  
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels() ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_row_groups()) %>%
  tab_style(
    style = cell_text(whitespace = "nowrap"),
    locations = cells_body()) %>%
  
  # Tide-specific row colors
  tab_style(
    style = cell_fill(color = "#F0F8FF"),  # Light blue for Low
    locations = cells_body(rows = tideHighLow == "Low") ) %>%
  tab_style(
    style = cell_fill(color = "#FFF8DC"),  # Light yellow for High  
    locations = cells_body(rows = tideHighLow == "High")) %>%
  
  fmt_number(
    columns = c(mean_JSD, sd_JSD, mean_Similarity, sd_Similarity),
    decimals = 3) %>%
  fmt_number(
    columns = c(n_indiv, n_comparisons),
    decimals = 0) %>%
  
  tab_options(
    table.font.size = px(13),
    heading.title.font.size = px(16),
    data_row.padding = px(3),
    table.width = pct(100),
    row_group.font.weight = "bold")


```

Let's now visualise the results with a boxplot.

```{r jensen-shannon tide 4, message = FALSE, warning = FALSE, eval = TRUE,  echo = FALSE}
# Prepare long-format data for JSD boxplot (matching entropy structure)
jsd_for_plot_tide <- jsd_results_tide %>%
  filter(same_species == TRUE) %>%
  select(species_1, tideHighLow, Band.ID_1, Band.ID_2, JSD) %>%
  rename(speciesEN = species_1, Band.ID = Band.ID_1) %>%  
  mutate(metric = "JSD") %>%
  select(speciesEN, tideHighLow, Band.ID, JSD, metric) %>%
  rename(value = JSD)

# Compute tide effect tests (Kruskal-Wallis since non-normal)
tide_tests_jsd <- jsd_for_plot_tide %>%
  group_by(speciesEN) %>%
  
  summarise(
    n_high = sum(tideHighLow == "High"),
    n_low = sum(tideHighLow == "Low"),
    
    # Wilcoxon rank-sum test (non-parametric t-test equivalent)
    p_value = if(n_high >= 3 & n_low >= 3) {
      wilcox.test(value ~ tideHighLow)$p.value  # NOT kruskal.test
      } else {NA},
    
    test_used = if(n_high >= 3 & n_low >= 3) "Wilcoxon rank-sum" else "insufficient data",
    .groups = "drop") %>%
  mutate(
    significance = case_when(
      is.na(p_value) ~ "",
      p_value < 0.001 ~ "***",
      p_value < 0.01 ~ "**", 
      p_value < 0.05 ~ "*",
      TRUE ~ "ns" ))


```

```{r jensen-shannon tide 5, message = FALSE, warning = FALSE, eval = TRUE,  echo = TRUE}
ggplot(
  jsd_for_plot_tide,
  aes(x = speciesEN, 
      y = value, 
      fill = speciesEN, 
      alpha = tideHighLow)) +
  
  geom_boxplot(aes(group = interaction(speciesEN, tideHighLow)), 
               position = position_dodge(width = 0.8), 
               outlier.shape = 16) +
  
  geom_point(aes(group = interaction(speciesEN, tideHighLow)),
           position = position_jitterdodge(jitter.width = 0.1, dodge.width = 0.8), 
           size = 1.1, alpha = 0.6) +
  
  scale_fill_manual(values = species_colors) +
  scale_alpha_manual(values = c("High" = 1.0, "Low" = 0.2)) +
  
  labs(
    title = "Within species Jensen-Shannon Divergence by Tide",
    subtitle = "JSD between individual pairs. (High tide: solid, Low tide: transparent)",
    x = "Species",
    y = "JSD",
    fill = "Species") +
  
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 9),
    strip.text = element_text(face = "bold", size = 11),
    legend.position = "none",
    panel.grid.major.x = element_blank())
  

```

We will use **Wilcoxon rank-sum** test for each species if the composition of site used is tide dependent. It is a non-parametric test which compare distributions between two independent groups without assuming normality.

```{r jensen-shannon tide 6, message = FALSE, warning = FALSE, eval = TRUE,  echo = FALSE}
tide_tests_jsd %>%
  
  select(speciesEN, n_high, n_low, p_value, significance) %>%
  
  gt() %>%
  
  tab_header(
    title = md("**Wilcoxon Test Results: High vs Low Tide JSD Comparison**"),
    subtitle = "Within species Jensen-Shannon Divergence between tide") %>%
  
  cols_label(
    speciesEN = "Species",
    n_high = "N High",
    n_low = "N Low", 
    p_value = "p-value",
    significance = "Sig." ) %>%
  
  tab_spanner(
    label = "Sample Size",
    columns = c(n_high, n_low)) %>%
  tab_spanner(
    label = "Tide Effect (High vs Low)",
    columns = c(p_value, significance)) %>%
  
  fmt_scientific(
    columns = p_value,
    decimals = 3) %>%
  
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(columns = significance)) %>%
  
  tab_style(
  style = cell_fill(color = "lightgreen"),
  locations = cells_body(
    columns = c(p_value, significance),
    rows = p_value < 0.05 & !is.na(p_value))) %>%
  
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels()) %>%
  tab_style(
    style = cell_text(whitespace = "nowrap"),
    locations = cells_body()) %>%
  tab_style(
    style = cell_text(whitespace = "nowrap"),
    locations = cells_column_labels() ) %>%
  
  tab_footnote(
    footnote = md("**Significance codes:** *** p < 0.001, ** p < 0.01, * p < 0.05, ns = not significant. **Wilcoxon rank-sum tests** compare JSD distributions between High vs Low tide **within each species**. Green highlighting indicates significant tide effects (p < 0.05).")) %>%
  
  opt_table_font(font = "Times New Roman") %>%
  tab_options(
    table.font.size = px(13),
    heading.title.font.size = px(16),
    data_row.padding = px(3),
    table.width = pct(100))

```
